<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Web Modeler" exporterVersion="e787c33" modeler:executionPlatform="Camunda Cloud" modeler:executionPlatformVersion="8.8.0">
  <bpmn:collaboration id="Collab_1">
    <bpmn:participant id="Pool_1" name="Оплата рахунків оренда та комунальні" processRef="Process_1" />
  </bpmn:collaboration>
  <bpmn:process id="Process_1" name="Оплата рахунків оренда та комунальні" isExecutable="true">
    <bpmn:extensionElements>
      <zeebe:versionTag value="1.0" />
    </bpmn:extensionElements>
    <bpmn:laneSet id="LaneSet_1">
      <bpmn:lane id="Lane_Buhgalter" name="Бухгалтер">
        <bpmn:flowNodeRef>StartEvent_1</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>GW_odoo_check</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>GW_odoo_merge</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>GW_intro_split</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_add_file</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_detail</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>GW_intro_merge</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>End_main</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_Camunda" name="Система (Camunda)">
        <bpmn:flowNodeRef>CA_per_invoice</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_Odoo" name="Система (Odoo авто)">
        <bpmn:flowNodeRef>Task_create_main</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>
    <bpmn:startEvent id="StartEvent_1" name="Старт">
      <bpmn:outgoing>Flow_start_to_gw_odoo</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:exclusiveGateway id="GW_odoo_check" name="Задача в Odoo існує?" default="Flow_odoo_no_task">
      <bpmn:incoming>Flow_start_to_gw_odoo</bpmn:incoming>
      <bpmn:outgoing>Flow_odoo_no_task</bpmn:outgoing>
      <bpmn:outgoing>Flow_odoo_has_task</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:serviceTask id="Task_create_main" name="Створити головне завдання">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="http-request-smart" />
        <zeebe:ioMapping>
          <zeebe:input source="= &#34;POST&#34;" target="method" />
          <zeebe:input source="= &#34;https://o.tut.ua/web/hook/8531324a-2785-48d1-8f4d-ddd66a267d50&#34;" target="url" />
          <zeebe:input source="= {&#34;Content-Type&#34;:&#34;application/json&#34;}" target="headers" />
          <zeebe:input source="= {name: &#34;Оплата рахунків оренда та комунальні&#34;, create_process: true, _model: &#34;project.project&#34;, _id: 252}" target="body" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_odoo_no_task</bpmn:incoming>
      <bpmn:outgoing>Flow_create_main_done</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:exclusiveGateway id="GW_odoo_merge">
      <bpmn:incoming>Flow_odoo_has_task</bpmn:incoming>
      <bpmn:incoming>Flow_create_main_done</bpmn:incoming>
      <bpmn:outgoing>Flow_odoo_merge_to_intro</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:parallelGateway id="GW_intro_split">
      <bpmn:incoming>Flow_odoo_merge_to_intro</bpmn:incoming>
      <bpmn:outgoing>Flow_split_to_add_file</bpmn:outgoing>
      <bpmn:outgoing>Flow_split_to_detail</bpmn:outgoing>
    </bpmn:parallelGateway>
    <bpmn:userTask id="Task_add_file" name="Додати файл з рахунком">
      <bpmn:extensionElements>
        <zeebe:userTask />
        <zeebe:ioMapping>
          <zeebe:input source="= &#34;POST&#34;" target="method" />
          <zeebe:input source="= &#34;https://o.tut.ua/web/hook/8531324a-2785-48d1-8f4d-ddd66a267d50&#34;" target="url" />
          <zeebe:input source="= {&#34;Content-Type&#34;:&#34;application/json&#34;}" target="headers" />
          <zeebe:input source="= {name: &#34;Додати файл рахунку&#34;, description: &#34;Завантажте файл рахунку для обробки&#34;, _model: &#34;project.project&#34;, _id: 252, x_studio_camunda_user_ids: x_studio_camunda_buhgalter_user_id, process_instance_key: process_instance_key}" target="body" />
          <zeebe:output source="= x_studio_camunda_invoice_file" target="x_studio_camunda_invoice_file" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_split_to_add_file</bpmn:incoming>
      <bpmn:outgoing>Flow_add_file_to_merge</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:userTask id="Task_detail" name="Деталізація рахунку">
      <bpmn:extensionElements>
        <zeebe:userTask />
        <zeebe:ioMapping>
          <zeebe:input source="= &#34;POST&#34;" target="method" />
          <zeebe:input source="= &#34;https://o.tut.ua/web/hook/8531324a-2785-48d1-8f4d-ddd66a267d50&#34;" target="url" />
          <zeebe:input source="= {&#34;Content-Type&#34;:&#34;application/json&#34;}" target="headers" />
          <zeebe:input source="= {name: &#34;Деталізація рахунку&#34;, description: &#34;Розбийте рахунок на окремі позиції. Для кожної позиції вкажіть: контрагент, сума, дата оплати, тип (Оренда/Комунальні/Маркетинг/ТО/ТП/ТП+). Якщо рахунок один — створіть одну позицію.&#34;, _model: &#34;project.project&#34;, _id: 252, x_studio_camunda_user_ids: x_studio_camunda_buhgalter_user_id, process_instance_key: process_instance_key}" target="body" />
          <zeebe:output source="= x_studio_camunda_invoice_items" target="invoice_items" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_split_to_detail</bpmn:incoming>
      <bpmn:outgoing>Flow_detail_to_merge</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:parallelGateway id="GW_intro_merge">
      <bpmn:incoming>Flow_add_file_to_merge</bpmn:incoming>
      <bpmn:incoming>Flow_detail_to_merge</bpmn:incoming>
      <bpmn:outgoing>Flow_merge_to_ca</bpmn:outgoing>
    </bpmn:parallelGateway>
    <bpmn:callActivity id="CA_per_invoice" name="Обробка окремого рахунку">
      <bpmn:extensionElements>
        <zeebe:calledElement processId="Process_single_invoice" propagateAllChildVariables="false" />
        <zeebe:ioMapping>
          <zeebe:input source="= item.partner_name" target="x_studio_camunda_partner_name" />
          <zeebe:input source="= item.invoice_amount" target="x_studio_camunda_invoice_amount" />
          <zeebe:input source="= item.payment_date" target="x_studio_camunda_payment_date" />
          <zeebe:input source="= item.invoice_type" target="x_studio_camunda_invoice_type" />
          <zeebe:input source="= x_studio_camunda_invoice_file" target="x_studio_camunda_invoice_file" />
          <zeebe:input source="= process_instance_key" target="parent_process_instance_key" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_merge_to_ca</bpmn:incoming>
      <bpmn:outgoing>Flow_ca_to_end</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics>
        <bpmn:extensionElements>
          <zeebe:loopCharacteristics inputCollection="= invoice_items" inputElement="item" />
        </bpmn:extensionElements>
      </bpmn:multiInstanceLoopCharacteristics>
    </bpmn:callActivity>
    <bpmn:endEvent id="End_main" name="Усі рахунки оброблено">
      <bpmn:incoming>Flow_ca_to_end</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_start_to_gw_odoo" sourceRef="StartEvent_1" targetRef="GW_odoo_check" />
    <bpmn:sequenceFlow id="Flow_odoo_no_task" sourceRef="GW_odoo_check" targetRef="Task_create_main" />
    <bpmn:sequenceFlow id="Flow_odoo_has_task" name="Задача існує" sourceRef="GW_odoo_check" targetRef="GW_odoo_merge">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= is defined(odoo_task_id) and odoo_task_id != null</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_create_main_done" sourceRef="Task_create_main" targetRef="GW_odoo_merge" />
    <bpmn:sequenceFlow id="Flow_odoo_merge_to_intro" sourceRef="GW_odoo_merge" targetRef="GW_intro_split" />
    <bpmn:sequenceFlow id="Flow_split_to_add_file" sourceRef="GW_intro_split" targetRef="Task_add_file" />
    <bpmn:sequenceFlow id="Flow_split_to_detail" sourceRef="GW_intro_split" targetRef="Task_detail" />
    <bpmn:sequenceFlow id="Flow_add_file_to_merge" sourceRef="Task_add_file" targetRef="GW_intro_merge" />
    <bpmn:sequenceFlow id="Flow_detail_to_merge" sourceRef="Task_detail" targetRef="GW_intro_merge" />
    <bpmn:sequenceFlow id="Flow_merge_to_ca" sourceRef="GW_intro_merge" targetRef="CA_per_invoice" />
    <bpmn:sequenceFlow id="Flow_ca_to_end" sourceRef="CA_per_invoice" targetRef="End_main" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collab_1">
      <bpmndi:BPMNShape id="Pool_1_di" bpmnElement="Pool_1" isHorizontal="true">
        <dc:Bounds x="-30" y="-10" width="1100" height="470" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_Odoo_di" bpmnElement="Lane_Odoo" isHorizontal="true">
        <dc:Bounds x="0" y="340" width="1070" height="120" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_Camunda_di" bpmnElement="Lane_Camunda" isHorizontal="true">
        <dc:Bounds x="0" y="220" width="1070" height="120" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_Buhgalter_di" bpmnElement="Lane_Buhgalter" isHorizontal="true">
        <dc:Bounds x="0" y="-10" width="1070" height="230" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="52" y="82" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="56" y="125" width="30" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="GW_odoo_check_di" bpmnElement="GW_odoo_check" isMarkerVisible="true">
        <dc:Bounds x="125" y="75" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="107" y="40" width="87" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_create_main_di" bpmnElement="Task_create_main">
        <dc:Bounds x="160" y="360" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="GW_odoo_merge_di" bpmnElement="GW_odoo_merge" isMarkerVisible="true">
        <dc:Bounds x="305" y="75" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="GW_intro_split_di" bpmnElement="GW_intro_split">
        <dc:Bounds x="395" y="75" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_add_file_di" bpmnElement="Task_add_file">
        <dc:Bounds x="490" y="10" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_detail_di" bpmnElement="Task_detail">
        <dc:Bounds x="490" y="120" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="GW_intro_merge_di" bpmnElement="GW_intro_merge">
        <dc:Bounds x="635" y="75" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="CA_per_invoice_di" bpmnElement="CA_per_invoice">
        <dc:Bounds x="740" y="250" width="120" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="End_main_di" bpmnElement="End_main">
        <dc:Bounds x="932" y="82" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="905" y="125" width="90" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_start_to_gw_odoo_di" bpmnElement="Flow_start_to_gw_odoo">
        <di:waypoint x="88" y="100" />
        <di:waypoint x="125" y="100" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_odoo_no_task_di" bpmnElement="Flow_odoo_no_task">
        <di:waypoint x="150" y="125" />
        <di:waypoint x="150" y="400" />
        <di:waypoint x="160" y="400" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_odoo_has_task_di" bpmnElement="Flow_odoo_has_task">
        <di:waypoint x="175" y="100" />
        <di:waypoint x="305" y="100" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="210" y="82" width="65" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_create_main_done_di" bpmnElement="Flow_create_main_done">
        <di:waypoint x="260" y="400" />
        <di:waypoint x="330" y="400" />
        <di:waypoint x="330" y="125" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_odoo_merge_to_intro_di" bpmnElement="Flow_odoo_merge_to_intro">
        <di:waypoint x="355" y="100" />
        <di:waypoint x="395" y="100" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_split_to_add_file_di" bpmnElement="Flow_split_to_add_file">
        <di:waypoint x="420" y="75" />
        <di:waypoint x="420" y="50" />
        <di:waypoint x="490" y="50" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_split_to_detail_di" bpmnElement="Flow_split_to_detail">
        <di:waypoint x="420" y="125" />
        <di:waypoint x="420" y="160" />
        <di:waypoint x="490" y="160" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_add_file_to_merge_di" bpmnElement="Flow_add_file_to_merge">
        <di:waypoint x="590" y="50" />
        <di:waypoint x="660" y="50" />
        <di:waypoint x="660" y="75" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_detail_to_merge_di" bpmnElement="Flow_detail_to_merge">
        <di:waypoint x="590" y="160" />
        <di:waypoint x="660" y="160" />
        <di:waypoint x="660" y="125" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_merge_to_ca_di" bpmnElement="Flow_merge_to_ca">
        <di:waypoint x="685" y="100" />
        <di:waypoint x="800" y="100" />
        <di:waypoint x="800" y="250" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ca_to_end_di" bpmnElement="Flow_ca_to_end">
        <di:waypoint x="860" y="290" />
        <di:waypoint x="950" y="290" />
        <di:waypoint x="950" y="118" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
