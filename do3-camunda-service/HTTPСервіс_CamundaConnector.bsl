// =============================================================================
// HTTP-сервіс для інтеграції Camunda 8.8 ↔ ДО 3.0
// =============================================================================
//
// Приймає POST-запити від Camunda (Service Task з job type: http-request-smart)
// Два режими роботи:
//   1. createDocument: true  → створює новий документ, повертає documentId
//   2. documentId: "UUID"    → оновлює існуючий документ
//
// Ключі JSON (крім службових) = імена реквізитів "Для розробників" у ДО 3.0
// =============================================================================

#Область ОбработчикиСервиса

// Головний обробник вхідного HTTP-запиту
//
// Параметри:
//   Запрос - HTTPСервисЗапрос
//
// Возвращаемое значение:
//   HTTPСервисОтвет - JSON з результатом
//
Функция ОбработкаВходящегоЗапроса(Запрос) Экспорт

	УстановитьПривилегированныйРежим(Истина);

	// --- Читання тіла запиту ---
	Попытка
		ТелоСтрока = Запрос.ПолучитьТелоКакСтроку("UTF-8");
	Исключение
		Возврат СформироватьОтвет(400, "ERROR", "Не вдалося прочитати тіло запиту");
	КонецПопытки;

	// Логування вхідного запиту
	ЗаписьЖурналаРегистрации("CamundaService.Запит",
		УровеньЖурналаРегистрации.Информация,,,
		ТелоСтрока);

	// --- Парсинг JSON ---
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоСтрока);
		// Истина = читати об'єкти як Соответствие (підтримує будь-які назви ключів)
		Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
		ЧтениеJSON.Закрыть();
	Исключение
		Возврат СформироватьОтвет(400, "ERROR", "Невалідний JSON: " + ОписаниеОшибки());
	КонецПопытки;

	// --- Маршрутизація ---
	Попытка
		СоздаватьДокумент = (Данные["createDocument"] = Истина);

		Если СоздаватьДокумент Тогда
			Возврат СоздатьДокумент(Данные);
		Иначе
			Возврат ОбновитьДокумент(Данные);
		КонецЕсли;
	Исключение
		ОписаниеОш = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации("CamundaService.Помилка",
			УровеньЖурналаРегистрации.Ошибка,,,
			ОписаниеОш);
		Возврат СформироватьОтвет(500, "ERROR", ОписаниеОшибки());
	КонецПопытки;

КонецФункции

#КонецОбласти

// =============================================================================
#Область СозданиеДокумента

Функция СоздатьДокумент(Данные)

	НазваВиду = Данные["documentType"];
	Если НазваВиду = Неопределено Или НазваВиду = "" Тогда
		Возврат СформироватьОтвет(400, "ERROR", "Не вказано documentType");
	КонецЕсли;

	// Пошук виду документа серед усіх типів ДО 3.0
	ВидДокумента = Неопределено;
	ИмяТипаДокумента = "";

	// Внутрішні документи
	ВидДокумента = Справочники.ВидыВнутреннихДокументов.НайтиПоНаименованию(НазваВиду, Истина);
	Если ЗначениеЗаполнено(ВидДокумента) Тогда
		ИмяТипаДокумента = "ВнутреннийДокумент";
	КонецЕсли;

	// Вхідні документи
	Если Не ЗначениеЗаполнено(ВидДокумента) Тогда
		ВидДокумента = Справочники.ВидыВходящихДокументов.НайтиПоНаименованию(НазваВиду, Истина);
		Если ЗначениеЗаполнено(ВидДокумента) Тогда
			ИмяТипаДокумента = "ВходящийДокумент";
		КонецЕсли;
	КонецЕсли;

	// Вихідні документи
	Если Не ЗначениеЗаполнено(ВидДокумента) Тогда
		ВидДокумента = Справочники.ВидыИсходящихДокументов.НайтиПоНаименованию(НазваВиду, Истина);
		Если ЗначениеЗаполнено(ВидДокумента) Тогда
			ИмяТипаДокумента = "ИсходящийДокумент";
		КонецЕсли;
	КонецЕсли;

	Если Не ЗначениеЗаполнено(ВидДокумента) Тогда
		Возврат СформироватьОтвет(404, "ERROR", "Вид документа не знайдено: " + НазваВиду);
	КонецЕсли;

	// Створення документа
	ДокументОбъект = Документы[ИмяТипаДокумента].СоздатьДокумент();
	ДокументОбъект.ВидДокумента = ВидДокумента;

	// Заповнення реквізитів з JSON
	ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные);

	ДокументОбъект.Записать();

	ИдДокумента = Строка(ДокументОбъект.Ссылка.УникальныйИдентификатор());

	ЗаписьЖурналаРегистрации("CamundaService.СтвореноДокумент",
		УровеньЖурналаРегистрации.Информация,
		ДокументОбъект.Метаданные(),
		ДокументОбъект.Ссылка,
		"Вид: " + НазваВиду + ", ID: " + ИдДокумента);

	// Відповідь: {"status": "OK", "documentId": "xxx"}
	ДанныеОтвета = Новый Соответствие;
	ДанныеОтвета.Вставить("status", "OK");
	ДанныеОтвета.Вставить("documentId", ИдДокумента);

	Возврат СформироватьОтветJSON(200, ДанныеОтвета);

КонецФункции

#КонецОбласти

// =============================================================================
#Область ОбновлениеДокумента

Функция ОбновитьДокумент(Данные)

	ИдДокумента = Данные["documentId"];
	Если ИдДокумента = Неопределено Или ИдДокумента = "" Тогда
		Возврат СформироватьОтвет(400, "ERROR", "Не вказано documentId");
	КонецЕсли;

	// Пошук документа по UUID
	СсылкаДокумента = НайтиДокументПоУИД(ИдДокумента);
	Если СсылкаДокумента = Неопределено Тогда
		Возврат СформироватьОтвет(404, "ERROR", "Документ не знайдено: " + ИдДокумента);
	КонецЕсли;

	ДокументОбъект = СсылкаДокумента.ПолучитьОбъект();

	// Заповнення реквізитів з JSON
	ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные);

	ДокументОбъект.Записать();

	ЗаписьЖурналаРегистрации("CamundaService.ОновленоДокумент",
		УровеньЖурналаРегистрации.Информация,
		ДокументОбъект.Метаданные(),
		ДокументОбъект.Ссылка,
		"ID: " + ИдДокумента);

	// Відповідь: {"status": "OK"}
	Возврат СформироватьОтвет(200, "OK");

КонецФункции

#КонецОбласти

// =============================================================================
#Область ЗаполнениеРеквизитов

// Заповнює реквізити документа даними з JSON.
// Логіка: спочатку шукає стандартний реквізит, потім — додатковий реквізит
// за іменем "Для розробників"
//
Процедура ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные)

	МетаданныеДок = ДокументОбъект.Метаданные();

	// Кеш стандартних реквізитів для швидкого пошуку
	СтандартныеРеквизиты = Новый Соответствие;
	Для Каждого Реквизит Из МетаданныеДок.Реквизиты Цикл
		СтандартныеРеквизиты.Вставить(Реквизит.Имя, Истина);
	КонецЦикла;

	Для Каждого КлючЗначение Из Данные Цикл

		ИмяПоля  = КлючЗначение.Ключ;
		Значение = КлючЗначение.Значение;

		// Пропустити службові поля
		Если ЭтоСлужебноеПоле(ИмяПоля) Тогда
			Продолжить;
		КонецЕсли;

		// 1. Стандартний реквізит документа
		Если СтандартныеРеквизиты[ИмяПоля] <> Неопределено Тогда
			ДокументОбъект[ИмяПоля] = Значение;
			Продолжить;
		КонецЕсли;

		// 2. Додатковий реквізит (за іменем "Для розробників")
		Свойство = НайтиДополнительныйРеквизит(ИмяПоля);
		Если Свойство <> Неопределено Тогда
			УстановитьДополнительныйРеквизит(ДокументОбъект, Свойство, Значение);
			Продолжить;
		КонецЕсли;

		// 3. Реквізит не знайдено — логуємо попередження
		ЗаписьЖурналаРегистрации("CamundaService.РеквізитНеЗнайдено",
			УровеньЖурналаРегистрации.Предупреждение,,,
			"Поле """ + ИмяПоля + """ не відповідає жодному реквізиту документа");

	КонецЦикла;

КонецПроцедуры

// Знаходить додатковий реквізит за іменем для розробників
Функция НайтиДополнительныйРеквизит(ИмяДляРазработчиков)

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Ссылка
	|ИЗ
	|	Справочник.ДополнительныеРеквизитыИСведения
	|ГДЕ
	|	Имя = &Имя
	|	И НЕ ПометкаУдаления";
	Запрос.УстановитьПараметр("Имя", ИмяДляРазработчиков);

	Результат = Запрос.Выполнить();
	Если Не Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Встановлює значення додаткового реквізиту в табличній частині документа
Процедура УстановитьДополнительныйРеквизит(ДокументОбъект, Свойство, Значение)

	// Шукаємо існуючий рядок
	Для Каждого Строка Из ДокументОбъект.ДополнительныеРеквизиты Цикл
		Если Строка.Свойство = Свойство Тогда
			Строка.Значение = Значение;
			Возврат;
		КонецЕсли;
	КонецЦикла;

	// Додаємо новий рядок
	НоваяСтрока = ДокументОбъект.ДополнительныеРеквизиты.Добавить();
	НоваяСтрока.Свойство = Свойство;
	НоваяСтрока.Значение = Значение;

КонецПроцедуры

#КонецОбласти

// =============================================================================
#Область ПоискДокумента

// Шукає документ по UUID серед усіх типів документів ДО 3.0
Функция НайтиДокументПоУИД(СтрокаУИД)

	Попытка
		УИД = Новый УникальныйИдентификатор(СтрокаУИД);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

	ТипыДокументов = Новый Массив;
	ТипыДокументов.Добавить("ВнутреннийДокумент");
	ТипыДокументов.Добавить("ВходящийДокумент");
	ТипыДокументов.Добавить("ИсходящийДокумент");

	Для Каждого ИмяТипа Из ТипыДокументов Цикл
		Попытка
			Ссылка = Документы[ИмяТипа].ПолучитьСсылку(УИД);
			Если Ссылка.ПолучитьОбъект() <> Неопределено Тогда
				Возврат Ссылка;
			КонецЕсли;
		Исключение
			Продолжить;
		КонецПопытки;
	КонецЦикла;

	Возврат Неопределено;

КонецФункции

#КонецОбласти

// =============================================================================
#Область ВспомогательныеФункции

// Перевіряє чи поле є службовим (не реквізит документа)
Функция ЭтоСлужебноеПоле(ИмяПоля)

	СлужебныеПоля = Новый Соответствие;
	СлужебныеПоля.Вставить("createDocument", Истина);
	СлужебныеПоля.Вставить("documentType",   Истина);
	СлужебныеПоля.Вставить("documentId",     Истина);

	Возврат СлужебныеПоля[ИмяПоля] = Истина;

КонецФункции

// Формує HTTP-відповідь з простим статусом
Функция СформироватьОтвет(КодСостояния, Статус, Сообщение = "")

	ДанныеОтвета = Новый Соответствие;
	ДанныеОтвета.Вставить("status", Статус);

	Если Сообщение <> "" Тогда
		ДанныеОтвета.Вставить("message", Сообщение);
	КонецЕсли;

	Возврат СформироватьОтветJSON(КодСостояния, ДанныеОтвета);

КонецФункции

// Формує HTTP-відповідь з довільним JSON
Функция СформироватьОтветJSON(КодСостояния, ДанныеОтвета)

	Ответ = Новый HTTPСервисОтвет(КодСостояния);
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");

	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ДанныеОтвета);

	Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть(), КодировкаТекста.UTF8);

	Возврат Ответ;

КонецФункции

#КонецОбласти
