<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:zeebe="http://camunda.org/schema/zeebe/1.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  id="Definitions_deploy"
                  targetNamespace="http://tut.ua/bpmn/deploy"
                  exporter="Claude Code"
                  exporterVersion="1.0">

  <!-- ═══════════════════════════════════════════════════════════
       DEPLOY PROCESS (Reusable Call Activity)

       Викликається з feature-to-production для staging та production.
       Параметризований: server_host, branch, db_name, container тощо.

       Job worker types:
         git-pull, detect-modules, docker-build, docker-up,
         module-update, cache-clear, smoke-test, http-verify,
         save-deploy-state, rollback
       ═══════════════════════════════════════════════════════════ -->

  <bpmn:error id="Error_deploy_failed" name="Deploy Failed" errorCode="DEPLOY_FAILED" />

  <bpmn:process id="deploy-process" name="Deploy Process" isExecutable="true">

    <!-- ── START ─────────────────────────────────────────────── -->
    <bpmn:startEvent id="evt_start" name="Початок деплою">
      <bpmn:outgoing>f01</bpmn:outgoing>
    </bpmn:startEvent>

    <!-- ── GIT PULL ──────────────────────────────────────────── -->
    <bpmn:serviceTask id="task_git_pull" name="Git Fetch &amp; Checkout">
      <bpmn:documentation>SSH на сервер, git fetch origin, checkout branch.
Retry 3x з інтервалом 5s.
Output: old_commit, new_commit, has_changes</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="git-pull" retries="3" />
      </bpmn:extensionElements>
      <bpmn:incoming>f01</bpmn:incoming>
      <bpmn:outgoing>f02</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── HAS CHANGES? ─────────────────────────────────────── -->
    <bpmn:exclusiveGateway id="gw_changes" name="Зміни є?" default="f04">
      <bpmn:incoming>f02</bpmn:incoming>
      <bpmn:outgoing>f03</bpmn:outgoing>
      <bpmn:outgoing>f04</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:endEvent id="evt_end_no_changes" name="Без змін">
      <bpmn:incoming>f03</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ── DETECT MODULES ────────────────────────────────────── -->
    <bpmn:serviceTask id="task_detect_modules" name="Визначити змінені модулі">
      <bpmn:documentation>git diff old..new, сканує src/custom, src/enterprise, src/third-party.
Якщо &gt;250 файлів — виводить "all".
Output: changed_modules, docker_build_needed</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="detect-modules" retries="1" />
      </bpmn:extensionElements>
      <bpmn:incoming>f04</bpmn:incoming>
      <bpmn:outgoing>f05</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── DOCKER BUILD NEEDED? ──────────────────────────────── -->
    <bpmn:exclusiveGateway id="gw_docker_build" name="Docker build?" default="f07">
      <bpmn:incoming>f05</bpmn:incoming>
      <bpmn:outgoing>f06</bpmn:outgoing>
      <bpmn:outgoing>f07</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="task_docker_build" name="Docker Build">
      <bpmn:documentation>docker compose build --pull web (retry 3x).
Потрібен тільки при зміні docker/, Dockerfile, requirements.txt.</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="docker-build" retries="3" />
      </bpmn:extensionElements>
      <bpmn:incoming>f06</bpmn:incoming>
      <bpmn:outgoing>f08</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="gw_merge_docker">
      <bpmn:incoming>f07</bpmn:incoming>
      <bpmn:incoming>f08</bpmn:incoming>
      <bpmn:outgoing>f09</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- ── DOCKER UP ─────────────────────────────────────────── -->
    <bpmn:serviceTask id="task_docker_up" name="Docker Up + Health Check">
      <bpmn:documentation>docker compose up -d, чекає container running (60s),
потім HTTP /web/login (24x10s = 240s).</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="docker-up" retries="1" />
      </bpmn:extensionElements>
      <bpmn:incoming>f09</bpmn:incoming>
      <bpmn:outgoing>f10</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── MODULE UPDATE ─────────────────────────────────────── -->
    <bpmn:serviceTask id="task_module_update" name="Оновити модулі Odoo">
      <bpmn:documentation>Зупиняє Odoo, запускає окремий контейнер:
docker compose run --rm web odoo-bin -d DB -u MODULES --stop-after-init --no-http
Якщо &gt;10 модулів — використовує -u all.
Output: modules_updated</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="module-update" retries="1" />
      </bpmn:extensionElements>
      <bpmn:incoming>f10</bpmn:incoming>
      <bpmn:outgoing>f11</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── CACHE CLEAR ───────────────────────────────────────── -->
    <bpmn:serviceTask id="task_cache_clear" name="Очистити кеш assets">
      <bpmn:documentation>DELETE FROM ir_attachment WHERE url LIKE '/web/assets/%' OR name LIKE 'web.assets%';
Запускає Odoo: docker compose up -d</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="cache-clear" retries="1" />
      </bpmn:extensionElements>
      <bpmn:incoming>f11</bpmn:incoming>
      <bpmn:outgoing>f12</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── SMOKE TEST? ───────────────────────────────────────── -->
    <bpmn:exclusiveGateway id="gw_smoke" name="Smoke test?" default="f14">
      <bpmn:incoming>f12</bpmn:incoming>
      <bpmn:outgoing>f13</bpmn:outgoing>
      <bpmn:outgoing>f14</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:serviceTask id="task_smoke_test" name="Smoke Test">
      <bpmn:documentation>Окремий контейнер: odoo-bin --stop-after-init --no-http (120s timeout).
Аналіз логів на CRITICAL/ERROR/ImportError/SyntaxError.
Output: smoke_passed</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="smoke-test" retries="1" />
      </bpmn:extensionElements>
      <bpmn:incoming>f13</bpmn:incoming>
      <bpmn:outgoing>f15</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:exclusiveGateway id="gw_merge_smoke">
      <bpmn:incoming>f14</bpmn:incoming>
      <bpmn:incoming>f15</bpmn:incoming>
      <bpmn:outgoing>f16</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <!-- ── HTTP VERIFY ───────────────────────────────────────── -->
    <bpmn:serviceTask id="task_http_verify" name="Перевірити HTTP /web/login">
      <bpmn:documentation>curl -sf http://localhost:PORT/web/login (24 спроби x 10s)</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="http-verify" retries="3" />
      </bpmn:extensionElements>
      <bpmn:incoming>f16</bpmn:incoming>
      <bpmn:outgoing>f17</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── SAVE STATE ────────────────────────────────────────── -->
    <bpmn:serviceTask id="task_save_state" name="Зберегти стан деплою">
      <bpmn:documentation>Записує new_commit SHA у .deploy-state/deploy_state_BRANCH</bpmn:documentation>
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="save-deploy-state" retries="1" />
      </bpmn:extensionElements>
      <bpmn:incoming>f17</bpmn:incoming>
      <bpmn:outgoing>f18</bpmn:outgoing>
    </bpmn:serviceTask>

    <!-- ── END SUCCESS ───────────────────────────────────────── -->
    <bpmn:endEvent id="evt_end_success" name="Деплой успішний">
      <bpmn:incoming>f18</bpmn:incoming>
    </bpmn:endEvent>

    <!-- ── ERROR EVENT SUBPROCESS (Rollback) ─────────────────── -->
    <bpmn:subProcess id="subprocess_error" name="Rollback on Error" triggeredByEvent="true">
      <bpmn:startEvent id="evt_error_catch" name="Помилка деплою" isInterrupting="true">
        <bpmn:outgoing>f_err1</bpmn:outgoing>
        <bpmn:errorEventDefinition id="ErrorDef_catch" />
      </bpmn:startEvent>

      <bpmn:serviceTask id="task_rollback" name="Rollback">
        <bpmn:documentation>git checkout old_commit, docker compose up -d --force-recreate.
Перевіряє чи є old_commit (якщо немає — no-op).</bpmn:documentation>
        <bpmn:extensionElements>
          <zeebe:taskDefinition type="rollback" retries="1" />
        </bpmn:extensionElements>
        <bpmn:incoming>f_err1</bpmn:incoming>
        <bpmn:outgoing>f_err2</bpmn:outgoing>
      </bpmn:serviceTask>

      <bpmn:endEvent id="evt_error_end" name="Деплой провалився">
        <bpmn:incoming>f_err2</bpmn:incoming>
        <bpmn:errorEventDefinition id="ErrorDef_throw" errorRef="Error_deploy_failed" />
      </bpmn:endEvent>

      <bpmn:sequenceFlow id="f_err1" sourceRef="evt_error_catch" targetRef="task_rollback" />
      <bpmn:sequenceFlow id="f_err2" sourceRef="task_rollback" targetRef="evt_error_end" />
    </bpmn:subProcess>

    <!-- ── SEQUENCE FLOWS ────────────────────────────────────── -->
    <bpmn:sequenceFlow id="f01" sourceRef="evt_start" targetRef="task_git_pull" />
    <bpmn:sequenceFlow id="f02" sourceRef="task_git_pull" targetRef="gw_changes" />
    <bpmn:sequenceFlow id="f03" name="Ні" sourceRef="gw_changes" targetRef="evt_end_no_changes">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=has_changes = false</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="f04" name="Так" sourceRef="gw_changes" targetRef="task_detect_modules" />
    <bpmn:sequenceFlow id="f05" sourceRef="task_detect_modules" targetRef="gw_docker_build" />
    <bpmn:sequenceFlow id="f06" name="Потрібен" sourceRef="gw_docker_build" targetRef="task_docker_build">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=docker_build_needed = true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="f07" sourceRef="gw_docker_build" targetRef="gw_merge_docker" />
    <bpmn:sequenceFlow id="f08" sourceRef="task_docker_build" targetRef="gw_merge_docker" />
    <bpmn:sequenceFlow id="f09" sourceRef="gw_merge_docker" targetRef="task_docker_up" />
    <bpmn:sequenceFlow id="f10" sourceRef="task_docker_up" targetRef="task_module_update" />
    <bpmn:sequenceFlow id="f11" sourceRef="task_module_update" targetRef="task_cache_clear" />
    <bpmn:sequenceFlow id="f12" sourceRef="task_cache_clear" targetRef="gw_smoke" />
    <bpmn:sequenceFlow id="f13" name="Так" sourceRef="gw_smoke" targetRef="task_smoke_test">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=run_smoke_test = true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="f14" sourceRef="gw_smoke" targetRef="gw_merge_smoke" />
    <bpmn:sequenceFlow id="f15" sourceRef="task_smoke_test" targetRef="gw_merge_smoke" />
    <bpmn:sequenceFlow id="f16" sourceRef="gw_merge_smoke" targetRef="task_http_verify" />
    <bpmn:sequenceFlow id="f17" sourceRef="task_http_verify" targetRef="task_save_state" />
    <bpmn:sequenceFlow id="f18" sourceRef="task_save_state" targetRef="evt_end_success" />

  </bpmn:process>

  <!-- ═══════════════════ DIAGRAM ═══════════════════ -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_deploy">
    <bpmndi:BPMNPlane id="BPMNPlane_deploy" bpmnElement="deploy-process">

      <!-- Start -->
      <bpmndi:BPMNShape id="evt_start_di" bpmnElement="evt_start">
        <dc:Bounds x="82" y="182" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- Git Pull -->
      <bpmndi:BPMNShape id="task_git_pull_di" bpmnElement="task_git_pull">
        <dc:Bounds x="170" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- GW Changes -->
      <bpmndi:BPMNShape id="gw_changes_di" bpmnElement="gw_changes" isMarkerVisible="true">
        <dc:Bounds x="365" y="175" width="50" height="50" />
      </bpmndi:BPMNShape>

      <!-- End No Changes -->
      <bpmndi:BPMNShape id="evt_end_no_changes_di" bpmnElement="evt_end_no_changes">
        <dc:Bounds x="372" y="302" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- Detect Modules -->
      <bpmndi:BPMNShape id="task_detect_modules_di" bpmnElement="task_detect_modules">
        <dc:Bounds x="480" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- GW Docker Build -->
      <bpmndi:BPMNShape id="gw_docker_build_di" bpmnElement="gw_docker_build" isMarkerVisible="true">
        <dc:Bounds x="675" y="175" width="50" height="50" />
      </bpmndi:BPMNShape>

      <!-- Docker Build (above) -->
      <bpmndi:BPMNShape id="task_docker_build_di" bpmnElement="task_docker_build">
        <dc:Bounds x="760" y="60" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- GW Merge Docker -->
      <bpmndi:BPMNShape id="gw_merge_docker_di" bpmnElement="gw_merge_docker" isMarkerVisible="true">
        <dc:Bounds x="955" y="175" width="50" height="50" />
      </bpmndi:BPMNShape>

      <!-- Docker Up -->
      <bpmndi:BPMNShape id="task_docker_up_di" bpmnElement="task_docker_up">
        <dc:Bounds x="1060" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- Module Update -->
      <bpmndi:BPMNShape id="task_module_update_di" bpmnElement="task_module_update">
        <dc:Bounds x="1260" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- Cache Clear -->
      <bpmndi:BPMNShape id="task_cache_clear_di" bpmnElement="task_cache_clear">
        <dc:Bounds x="1460" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- GW Smoke -->
      <bpmndi:BPMNShape id="gw_smoke_di" bpmnElement="gw_smoke" isMarkerVisible="true">
        <dc:Bounds x="1655" y="175" width="50" height="50" />
      </bpmndi:BPMNShape>

      <!-- Smoke Test (above) -->
      <bpmndi:BPMNShape id="task_smoke_test_di" bpmnElement="task_smoke_test">
        <dc:Bounds x="1740" y="60" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- GW Merge Smoke -->
      <bpmndi:BPMNShape id="gw_merge_smoke_di" bpmnElement="gw_merge_smoke" isMarkerVisible="true">
        <dc:Bounds x="1935" y="175" width="50" height="50" />
      </bpmndi:BPMNShape>

      <!-- HTTP Verify -->
      <bpmndi:BPMNShape id="task_http_verify_di" bpmnElement="task_http_verify">
        <dc:Bounds x="2040" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- Save State -->
      <bpmndi:BPMNShape id="task_save_state_di" bpmnElement="task_save_state">
        <dc:Bounds x="2240" y="160" width="140" height="80" />
      </bpmndi:BPMNShape>

      <!-- End Success -->
      <bpmndi:BPMNShape id="evt_end_success_di" bpmnElement="evt_end_success">
        <dc:Bounds x="2442" y="182" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- Error Event Subprocess -->
      <bpmndi:BPMNShape id="subprocess_error_di" bpmnElement="subprocess_error" isExpanded="true">
        <dc:Bounds x="170" y="360" width="400" height="120" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="evt_error_catch_di" bpmnElement="evt_error_catch">
        <dc:Bounds x="200" y="402" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="task_rollback_di" bpmnElement="task_rollback">
        <dc:Bounds x="290" y="380" width="140" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="evt_error_end_di" bpmnElement="evt_error_end">
        <dc:Bounds x="490" y="402" width="36" height="36" />
      </bpmndi:BPMNShape>

      <!-- ═══ EDGES ═══ -->

      <!-- f01: Start → Git Pull -->
      <bpmndi:BPMNEdge id="f01_di" bpmnElement="f01">
        <di:waypoint x="118" y="200" />
        <di:waypoint x="170" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f02: Git Pull → GW Changes -->
      <bpmndi:BPMNEdge id="f02_di" bpmnElement="f02">
        <di:waypoint x="310" y="200" />
        <di:waypoint x="365" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f03: GW Changes → End No Changes (down) -->
      <bpmndi:BPMNEdge id="f03_di" bpmnElement="f03">
        <di:waypoint x="390" y="225" />
        <di:waypoint x="390" y="302" />
      </bpmndi:BPMNEdge>

      <!-- f04: GW Changes → Detect Modules (right) -->
      <bpmndi:BPMNEdge id="f04_di" bpmnElement="f04">
        <di:waypoint x="415" y="200" />
        <di:waypoint x="480" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f05: Detect Modules → GW Docker Build -->
      <bpmndi:BPMNEdge id="f05_di" bpmnElement="f05">
        <di:waypoint x="620" y="200" />
        <di:waypoint x="675" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f06: GW Docker Build → Docker Build (up) -->
      <bpmndi:BPMNEdge id="f06_di" bpmnElement="f06">
        <di:waypoint x="700" y="175" />
        <di:waypoint x="700" y="100" />
        <di:waypoint x="760" y="100" />
      </bpmndi:BPMNEdge>

      <!-- f07: GW Docker Build → GW Merge Docker (skip) -->
      <bpmndi:BPMNEdge id="f07_di" bpmnElement="f07">
        <di:waypoint x="725" y="200" />
        <di:waypoint x="955" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f08: Docker Build → GW Merge Docker -->
      <bpmndi:BPMNEdge id="f08_di" bpmnElement="f08">
        <di:waypoint x="900" y="100" />
        <di:waypoint x="980" y="100" />
        <di:waypoint x="980" y="175" />
      </bpmndi:BPMNEdge>

      <!-- f09: GW Merge Docker → Docker Up -->
      <bpmndi:BPMNEdge id="f09_di" bpmnElement="f09">
        <di:waypoint x="1005" y="200" />
        <di:waypoint x="1060" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f10: Docker Up → Module Update -->
      <bpmndi:BPMNEdge id="f10_di" bpmnElement="f10">
        <di:waypoint x="1200" y="200" />
        <di:waypoint x="1260" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f11: Module Update → Cache Clear -->
      <bpmndi:BPMNEdge id="f11_di" bpmnElement="f11">
        <di:waypoint x="1400" y="200" />
        <di:waypoint x="1460" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f12: Cache Clear → GW Smoke -->
      <bpmndi:BPMNEdge id="f12_di" bpmnElement="f12">
        <di:waypoint x="1600" y="200" />
        <di:waypoint x="1655" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f13: GW Smoke → Smoke Test (up) -->
      <bpmndi:BPMNEdge id="f13_di" bpmnElement="f13">
        <di:waypoint x="1680" y="175" />
        <di:waypoint x="1680" y="100" />
        <di:waypoint x="1740" y="100" />
      </bpmndi:BPMNEdge>

      <!-- f14: GW Smoke → GW Merge Smoke (skip) -->
      <bpmndi:BPMNEdge id="f14_di" bpmnElement="f14">
        <di:waypoint x="1705" y="200" />
        <di:waypoint x="1935" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f15: Smoke Test → GW Merge Smoke -->
      <bpmndi:BPMNEdge id="f15_di" bpmnElement="f15">
        <di:waypoint x="1880" y="100" />
        <di:waypoint x="1960" y="100" />
        <di:waypoint x="1960" y="175" />
      </bpmndi:BPMNEdge>

      <!-- f16: GW Merge Smoke → HTTP Verify -->
      <bpmndi:BPMNEdge id="f16_di" bpmnElement="f16">
        <di:waypoint x="1985" y="200" />
        <di:waypoint x="2040" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f17: HTTP Verify → Save State -->
      <bpmndi:BPMNEdge id="f17_di" bpmnElement="f17">
        <di:waypoint x="2180" y="200" />
        <di:waypoint x="2240" y="200" />
      </bpmndi:BPMNEdge>

      <!-- f18: Save State → End Success -->
      <bpmndi:BPMNEdge id="f18_di" bpmnElement="f18">
        <di:waypoint x="2380" y="200" />
        <di:waypoint x="2442" y="200" />
      </bpmndi:BPMNEdge>

      <!-- Error subprocess edges -->
      <bpmndi:BPMNEdge id="f_err1_di" bpmnElement="f_err1">
        <di:waypoint x="236" y="420" />
        <di:waypoint x="290" y="420" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="f_err2_di" bpmnElement="f_err2">
        <di:waypoint x="430" y="420" />
        <di:waypoint x="490" y="420" />
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
