<?xml version="1.0" encoding="UTF-8"?>
<definitions
  xmlns="https://www.omg.org/spec/DMN/20191111/MODEL/"
  xmlns:dmndi="https://www.omg.org/spec/DMN/20191111/DMNDI/"
  xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/"
  xmlns:modeler="http://camunda.org/schema/modeler/1.0"
  id="Definitions_invoice_detail"
  name="Деталізація рахунків"
  namespace="http://camunda.org/schema/1.0/dmn"
  exporter="Camunda Web Modeler"
  exporterVersion="e787c33"
  modeler:executionPlatform="Camunda Cloud"
  modeler:executionPlatformVersion="8.8.0">

  <!--
    DMN — Деталізація рахунків за назвою позиції
    ============================================================

    Призначення: автоматична класифікація окремих позицій рахунку
    за видом (оренда / комунальні) на основі назви послуги.

    Використовується в процесі "Оплата рахунків оренда та комунальні v2":
      - Один документ від постачальника може містити кілька рахунків
      - Кожна позиція класифікується окремо через цю DMN
      - Результат визначає подальшу маршрутизацію (погоджувач, переговори)

    Вхідні змінні:
      - x_studio_camunda_invoice_line_name  — назва позиції/послуги з рахунку
      - x_studio_camunda_partner_name       — назва постачальника (контрагент 2)

    Вихідні змінні:
      - x_studio_camunda_invoice_type       — вид рахунку: "rent" | "utilities"
      - x_studio_camunda_invoice_notes      — примітки щодо обробки позиції

    Hit Policy: FIRST — спрацьовує перше правило що підійшло.
    Matching: contains() по ключових словах (регістронезалежно через lower case).

    Джерело даних: "Деталізація рахунків (2).xlsx"
  -->

  <decision id="invoice-detail-type" name="Деталізація рахунків">
    <decisionTable id="decisionTable_invoice_detail" hitPolicy="FIRST">

      <!-- ── INPUTS ──────────────────────────────────────────────────────── -->

      <input id="input_line_name" label="Назва позиції рахунку">
        <inputExpression id="inputExpr_line_name" typeRef="string">
          <text>lower case(x_studio_camunda_invoice_line_name)</text>
        </inputExpression>
      </input>

      <input id="input_partner" label="Постачальник">
        <inputExpression id="inputExpr_partner" typeRef="string">
          <text>x_studio_camunda_partner_name</text>
        </inputExpression>
      </input>

      <!-- ── OUTPUTS ─────────────────────────────────────────────────────── -->

      <output id="output_invoice_type"
              label="Вид рахунку"
              name="x_studio_camunda_invoice_type"
              typeRef="string">
        <outputValues id="outputValues_type">
          <text>"rent","utilities"</text>
        </outputValues>
      </output>

      <output id="output_notes"
              label="Примітки обробки"
              name="x_studio_camunda_invoice_notes"
              typeRef="string" />

      <!-- ══════════════════════════════════════════════════════════════════
           ПРАВИЛА — специфічні ключові слова (від найконкретніших до загальних)
           ══════════════════════════════════════════════════════════════════ -->

      <!-- ── Герман Олена Василівна (підрозділ 906) ──────────────────────── -->

      <!-- Суборенда приміщення → оренда -->
      <rule id="rule_suborenda">
        <description>906: Суборенда приміщення — оренда</description>
        <inputEntry id="ie_suborenda"><text>contains(?, "суборенда приміщення")</text></inputEntry>
        <inputEntry id="ie_suborenda_p"><text></text></inputEntry>
        <outputEntry id="oe_suborenda_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_suborenda_notes"><text>""</text></outputEntry>
      </rule>

      <!-- Експлуатаційна суборендна плата → комунальні -->
      <rule id="rule_ekspl_subor">
        <description>906: Експлуатаційна суборендна плата — комунальні. Місяць оплати з рахунку на оренду</description>
        <inputEntry id="ie_ekspl_subor"><text>contains(?, "експлуатаційна суборендна плата")</text></inputEntry>
        <inputEntry id="ie_ekspl_subor_p"><text></text></inputEntry>
        <outputEntry id="oe_ekspl_subor_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_ekspl_subor_notes"><text>"місяць оплати з рахунку на оренду"</text></outputEntry>
      </rule>

      <!-- Маркетингова суборендна плата → комунальні -->
      <rule id="rule_market_subor">
        <description>906: Маркетингова суборендна плата — комунальні. Місяць оплати з рахунку на оренду</description>
        <inputEntry id="ie_market_subor"><text>contains(?, "маркетингова суборендна плата")</text></inputEntry>
        <inputEntry id="ie_market_subor_p"><text></text></inputEntry>
        <outputEntry id="oe_market_subor_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_market_subor_notes"><text>"місяць оплати з рахунку на оренду"</text></outputEntry>
      </rule>

      <!-- Розміщення рекламного матеріалу → комунальні -->
      <rule id="rule_reklam_material">
        <description>906: Розміщення рекламного матеріалу на конструкціях — комунальні</description>
        <inputEntry id="ie_reklam_material"><text>contains(?, "розміщення рекламного матеріалу")</text></inputEntry>
        <inputEntry id="ie_reklam_material_p"><text></text></inputEntry>
        <outputEntry id="oe_reklam_material_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_reklam_material_notes"><text>""</text></outputEntry>
      </rule>

      <!-- ── ЛЬВІВБУДМАКС-ІНВЕСТ (підрозділ 605) ────────────────────────── -->

      <!-- Оренда нерухомого майна → оренда -->
      <rule id="rule_orenda_neruhomogo">
        <description>605: Оренда нерухомого майна — оренда. Місяць за датою виставлення рахунку</description>
        <inputEntry id="ie_orenda_neruhomogo"><text>contains(?, "оренда нерухомого майна")</text></inputEntry>
        <inputEntry id="ie_orenda_neruhomogo_p"><text></text></inputEntry>
        <outputEntry id="oe_orenda_neruhomogo_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_orenda_neruhomogo_notes"><text>"місяць оренди за датою виставлення рахунку"</text></outputEntry>
      </rule>

      <!-- ── Сільпо фуд (підрозділ 909) ──────────────────────────────────── -->

      <!-- Оплата комунальних → комунальні -->
      <rule id="rule_oplata_komunal">
        <description>909: Оплата комунальних згідно договору суборенди — комунальні. Деталізація в окремому документі</description>
        <inputEntry id="ie_oplata_komunal"><text>contains(?, "оплата комунальних")</text></inputEntry>
        <inputEntry id="ie_oplata_komunal_p"><text></text></inputEntry>
        <outputEntry id="oe_oplata_komunal_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_oplata_komunal_notes"><text>"деталізація в окремому документі"</text></outputEntry>
      </rule>

      <!-- ── Житомирський меблевий комбінат (підрозділи 507, 908, 602) ──── -->

      <!-- Орендна плата → оренда -->
      <rule id="rule_orendna_plata">
        <description>507/908/602: Орендна плата — оренда</description>
        <inputEntry id="ie_orendna_plata"><text>contains(?, "орендна плата")</text></inputEntry>
        <inputEntry id="ie_orendna_plata_p"><text></text></inputEntry>
        <outputEntry id="oe_orendna_plata_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_orendna_plata_notes"><text>""</text></outputEntry>
      </rule>

      <!-- Рекламні послуги → оренда (входить до орендного пакету) -->
      <rule id="rule_reklamni_poslugy">
        <description>507/908/602: Рекламні послуги — оренда (входить до орендного пакету)</description>
        <inputEntry id="ie_reklamni_poslugy"><text>contains(?, "рекламні послуги")</text></inputEntry>
        <inputEntry id="ie_reklamni_poslugy_p"><text></text></inputEntry>
        <outputEntry id="oe_reklamni_poslugy_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_reklamni_poslugy_notes"><text>""</text></outputEntry>
      </rule>

      <!-- Компенсація комунальних послуг → комунальні -->
      <rule id="rule_kompensacia_komunal">
        <description>507/908/602: Компенсація комунальних послуг — комунальні</description>
        <inputEntry id="ie_kompensacia_komunal"><text>contains(?, "компенсація комунальних")</text></inputEntry>
        <inputEntry id="ie_kompensacia_komunal_p"><text></text></inputEntry>
        <outputEntry id="oe_kompensacia_komunal_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_kompensacia_komunal_notes"><text>""</text></outputEntry>
      </rule>

      <!-- ══════════════════════════════════════════════════════════════════
           ПРАВИЛА — загальні ключові слова (catch-all по категоріях)
           ══════════════════════════════════════════════════════════════════ -->

      <!-- Будь-що з "суборенд" → оренда -->
      <rule id="rule_generic_suborenda">
        <description>Загальне: будь-яка суборенда — оренда</description>
        <inputEntry id="ie_generic_suborenda"><text>contains(?, "суборенд")</text></inputEntry>
        <inputEntry id="ie_generic_suborenda_p"><text></text></inputEntry>
        <outputEntry id="oe_generic_suborenda_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_generic_suborenda_notes"><text>""</text></outputEntry>
      </rule>

      <!-- Будь-що з "оренд" → оренда -->
      <rule id="rule_generic_orenda">
        <description>Загальне: будь-яка оренда — оренда</description>
        <inputEntry id="ie_generic_orenda"><text>contains(?, "оренд")</text></inputEntry>
        <inputEntry id="ie_generic_orenda_p"><text></text></inputEntry>
        <outputEntry id="oe_generic_orenda_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_generic_orenda_notes"><text>""</text></outputEntry>
      </rule>

      <!-- Будь-що з "комунальн" → комунальні -->
      <rule id="rule_generic_komunal">
        <description>Загальне: будь-які комунальні — комунальні</description>
        <inputEntry id="ie_generic_komunal"><text>contains(?, "комунальн")</text></inputEntry>
        <inputEntry id="ie_generic_komunal_p"><text></text></inputEntry>
        <outputEntry id="oe_generic_komunal_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_generic_komunal_notes"><text>""</text></outputEntry>
      </rule>

      <!-- Будь-що з "експлуатаці" → комунальні -->
      <rule id="rule_generic_ekspluatacia">
        <description>Загальне: експлуатація — комунальні</description>
        <inputEntry id="ie_generic_ekspluatacia"><text>contains(?, "експлуатаці")</text></inputEntry>
        <inputEntry id="ie_generic_ekspluatacia_p"><text></text></inputEntry>
        <outputEntry id="oe_generic_ekspluatacia_type"><text>"utilities"</text></outputEntry>
        <outputEntry id="oe_generic_ekspluatacia_notes"><text>""</text></outputEntry>
      </rule>

      <!-- ══════════════════════════════════════════════════════════════════
           DEFAULT — невідома позиція
           ══════════════════════════════════════════════════════════════════ -->

      <rule id="rule_default">
        <description>Невідома позиція — потребує ручної класифікації</description>
        <inputEntry id="ie_default_line"><text></text></inputEntry>
        <inputEntry id="ie_default_partner"><text></text></inputEntry>
        <outputEntry id="oe_default_type"><text>"rent"</text></outputEntry>
        <outputEntry id="oe_default_notes"><text>"невідома позиція — потребує ручної класифікації"</text></outputEntry>
      </rule>

    </decisionTable>
  </decision>

  <!-- ═══════════════════════════════════════════════════════════════════
       DMNDI — візуальне розташування
       ═══════════════════════════════════════════════════════════════════ -->
  <dmndi:DMNDI>
    <dmndi:DMNDiagram id="DMNDiagram_detail">
      <dmndi:DMNShape id="DMNShape_invoice_detail" dmnElementRef="invoice-detail-type">
        <dc:Bounds x="160" y="100" width="200" height="80" />
      </dmndi:DMNShape>
    </dmndi:DMNDiagram>
  </dmndi:DMNDI>

</definitions>
